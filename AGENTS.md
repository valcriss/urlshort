# AGENTS.md

## 🎯 Project Goal
Build a **self-hosted URL shortener service**, secure and extensible.

The service must provide:
- A **public endpoint** (`https://<domain>/<code>`) that redirects to a long URL.
- An **admin backend** (`/backend`) protected by **Keycloak**, where authenticated users can create, edit, and delete URLs.
- A **REST API** (`/api/url`) returning JSON, authenticated via Keycloak JWT, allowing programmatic management of URLs.

Each short URL created is **attached to the user who created it**, identified by their email address from Keycloak.

## ⚙️ Technology Stack
- **Language**: TypeScript (Node.js 20+)
- **Framework**: Express.js
- **ORM**: Prisma (PostgreSQL)
- **Database**: PostgreSQL 14+
- **Auth**: Keycloak via OpenID Connect (JWT)
- **Admin override**: **Admin token** via environment variable, used as a Bearer token to bypass Keycloak (see *Authentication*).
- **Containerization**: Docker (optional)
- **Tests**: Jest
- **Linting**: ESLint
- **Pre-commit checks**: all tests must pass and ESLint must run without errors or warnings
- **Logging**: structured logs (pino or morgan)

## 📐 Architecture
### Services
1. **Redirection**
   - `GET /:code`
   - Redirects (302) to the associated long URL.
   - Returns `404` if code not found.
   - Returns `410 Gone` if the URL has expired (`expiresAt < now`).
   - **Statistics**: upon each successful redirect, **increment** `clickCount` and set `lastAccessAt` to current time.
   - Response headers: `Cache-Control: no-store`, `X-Robots-Tag: noindex`.

2. **API REST `/api/url`**
   - Protected by Keycloak JWT **or** by a special **Admin token** (Bearer) defined via env var.
   - Endpoints:
     - **GET** `/api/url` → returns the list of short URLs **created by the authenticated user**. When called **with Admin token**, the caller may pass `?email=<email>` to list URLs for a specific user.
     - **GET** `/api/url/{code}` → returns details of a single short URL. **Normal users** can only access their own URLs; **Admin token** can access any.
     - **POST** `/api/url` → create short URL (code auto-generated by server). When called **with Admin token**, an optional `email` field in the body can set `createdBy` explicitly.
     - **PUT** `/api/url` → update an existing short URL by code.
     - **DELETE** `/api/url` → delete a short URL by code.
   - Each URL is associated with the user that created it (`createdBy`).
   - Returns JSON.
   - Error codes: `400` invalid input, `403` forbidden, `404` not found, `409` conflict, `410` gone.

3. **Admin UI `/backend`**
   - Protected by Keycloak.
   - SPA or server-rendered pages.
   - Features:
     - **Table view** listing the URLs **created by the logged-in user**.
       - The **last column** includes two buttons per row: **Edit** and **Delete**.
       - Recommended columns: `label`, `code`, `longUrl`, `expiresAt`, **`clickCount`**, **`lastAccessAt`**.
     - An **"Add"** button **above the table** opens a **modal dialog** to add a new URL via a form (label, longUrl, optional expiresAt).
     - The **Edit** button opens a **modal dialog** pre-filled with the row data to update the record (label, longUrl, expiresAt).
     - The **Delete** button triggers a **confirmation dialog**; on confirmation, the record is deleted.
     - Copy link button (per row) is recommended.
   - Audit fields shown: `createdBy`, `createdAt`, `updatedBy`, `updatedAt`.

## 🗄️ Data Model (Prisma)

```prisma
model ShortUrl {
  code         String     @id @db.VarChar(32)
  label        String     @db.VarChar(120)
  longUrl      String     @db.Text
  expiresAt    DateTime?  @db.Timestamptz
  createdBy    String     @db.Text   // user email (Keycloak or admin-provided)
  updatedBy    String     @db.Text
  createdAt    DateTime   @default(now()) @db.Timestamptz
  updatedAt    DateTime   @updatedAt @db.Timestamptz
  // Stats
  clickCount   Int        @default(0)
  lastAccessAt DateTime?  @db.Timestamptz

  @@index([expiresAt], map: "idx_short_urls_expires_at")
  @@index([lastAccessAt], map: "idx_short_urls_last_access_at")
}
```

Constraints:
- `code` is unique.
- `longUrl` must be valid (http/https only).
- `expiresAt` is optional.
- Each record is linked to a user via `createdBy`.
- Statistics fields: `clickCount` (increment-on-redirect), `lastAccessAt` (timestamp of last successful redirect).

### Statistics update semantics
- On **successful redirect** (non-expired, known code):
  - `clickCount = clickCount + 1`
  - `lastAccessAt = now()`
- Use a **single atomic update** to avoid race conditions, e.g. Prisma's `update` with `increment`.
- Keep the existing in-memory LRU cache for performance; **do not skip** DB stat updates when served from cache.
  - Accept eventual write contention at high QPS; if needed, switch to batched/async counters later.

## 🔑 Authentication & Admin Token
- **Keycloak (OIDC, JWT)**
  - Required claim: `email` → used for `createdBy`/`updatedBy`.
  - Middleware verifies JWT with JWKS from Keycloak; extracts `email` into `req.userEmail`.
- **Admin Token bypass**
  - Environment variable: `ADMIN_BEARER_TOKEN` (exact name can be adjusted; must be long, random, secret).
  - If the request contains header `Authorization: Bearer <ADMIN_BEARER_TOKEN>`, **Keycloak validation is bypassed** and the request is treated as **admin**.
  - **Admin-specific behaviors**:
    - **POST** `/api/url`: accept an optional body field `email` to set `createdBy` for the new record; if omitted, fallback to an admin default (e.g., `system@local`).
    - **GET** `/api/url`: accept optional query `?email=<email>` to list URLs for that user; if not provided, return all URLs or default scope as per policy (recommended: **require** `email` for admin listing to avoid accidental full dumps).
    - **GET** `/api/url/{code}`: return details of any URL by code, regardless of owner.
  - **Security note**: The admin token grants elevated privileges; store it only as a secret env var, never in client-side code, rotate regularly, and restrict network access.

## 📦 Project Structure

```
.
├── prisma/
│   └── schema.prisma
├── src/
│   ├── middleware/
│   │   └── auth.ts         # JWT verification + admin token bypass
│   ├── routes/
│   │   ├── api.ts          # GET/POST/PUT/DELETE /api/url (+ GET /api/url/:code)
│   │   └── redirect.ts     # GET /:code (with stats updates)
│   ├── services/
│   │   └── shortUrl.service.ts
│   ├── utils/
│   │   ├── code.ts         # Generate short codes
│   │   └── validate.ts     # Validate long URLs
│   ├── server.ts           # Express entry point
├── package.json
├── tsconfig.json
├── .eslintrc.json
└── .env
```

## 📜 API Specification (simplified OpenAPI)

```yaml
openapi: 3.0.3
info:
  title: UrlShort
  version: 1.0.0
servers:
  - url: https://<domain>
paths:
  /api/url:
    get:
      summary: List short URLs
      description: Returns URLs created by the authenticated user. When using the Admin token, you may pass `email` to list another user's URLs.
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: query
          name: email
          schema: { type: string, format: email }
          description: Admin-only. If provided with Admin token, lists URLs for this email.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ShortUrl'
  /api/url/{code}:
    get:
      summary: Get details for a specific short URL
      description: Returns the full ShortUrl object if the caller owns it. When using the Admin token, any code can be retrieved.
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: code
          required: true
          schema: { type: string, pattern: '^[A-Za-z0-9]{6}$' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShortUrl'
        '403': { description: Forbidden (caller does not own this code) }
        '404': { description: Not Found }
  
    get:
      summary: List short URLs
      description: Returns URLs created by the authenticated user. When using the Admin token, you may pass `email` to list another user's URLs.
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: query
          name: email
          schema: { type: string, format: email }
          description: Admin-only. If provided with Admin token, lists URLs for this email.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ShortUrl'
  /api/url/{code}:
    get:
      summary: Get details of a short URL by code
      description: Returns the details of the given short URL if owned by the authenticated user, or accessible via Admin token.
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: code
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShortUrl'
        '404': { description: Not Found }
  /api/url:
    post:
      summary: Create short URL
      description: Code is server-generated. When using the Admin token, an optional `email` in the body sets `createdBy`.
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [label, longUrl]
              properties:
                label: { type: string }
                longUrl: { type: string, format: uri }
                expiresAt: { type: string, format: date-time, nullable: true }
                email:
                  type: string
                  format: email
                  description: Admin-only. Overrides createdBy.
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShortUrl'
    put:
      summary: Update short URL
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code: { type: string }
                label: { type: string }
                longUrl: { type: string, format: uri }
                expiresAt: { type: string, format: date-time, nullable: true }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    delete:
      summary: Delete short URL
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code: { type: string }
      responses:
        '204': { description: No Content }
        '404': { description: Not Found }
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ShortUrl:
      type: object
      properties:
        code: { type: string }
        label: { type: string }
        longUrl: { type: string, format: uri }
        expiresAt: { type: string, format: date-time, nullable: true }
        createdBy: { type: string, format: email }
        updatedBy: { type: string, format: email }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        clickCount: { type: integer }
        lastAccessAt: { type: string, format: date-time, nullable: true }
```

## 🧪 Acceptance Tests
1. **GET** `/api/url` with normal JWT → returns only the caller's URLs.
2. **GET** `/api/url?email=user@example.com` with **Admin token** → returns the specified user's URLs.
3. **GET** `/api/url/{code}` with normal JWT →
   - If the code belongs to caller → `200` with details.
   - If the code belongs to someone else → `403`.
   - If unknown → `404`.
4. **POST** `/api/url` with normal JWT → creates URL with `createdBy` set to caller's email.
5. **POST** `/api/url` with **Admin token** and body `{ email: "user@example.com" }` → creates URL with `createdBy=user@example.com`.
6. **GET** `/:code` on active URL → 302 redirect, **clickCount increments by 1**, **lastAccessAt is updated**.
7. **GET** `/:code` on expired URL → 410 Gone (no stats increment).
8. **PUT** `/api/url` updates label/URL/expiry → reflected in DB, `updatedBy` set correctly.
9. **DELETE** `/api/url` → subsequent GET returns 404.
10. POST invalid URL (e.g. ftp://) → 400.

## 🔍 Linting & Testing
- ESLint must be configured (strict rules, TypeScript plugin).
- Jest for unit and integration tests.
- Pre-commit hook (Husky or similar):
  - Run `npm run lint` → must pass with **no errors or warnings**.
  - Run `npm test` → all tests must pass.

## 🚀 Future Extensions
- Custom codes for admin users.
- Aggregated analytics (daily/weekly counts, unique IPs via hashed fingerprints).
- Quotas per user.
- Tags/categories for easier management in UI.

---

This document contains all the necessary details for an AI agent (or developer) to generate the full project, set up environment, implement API, database schema (including **statistics fields**), authentication (including **Admin token bypass**), linting, testing, and pre-commit checks. Every short URL is explicitly linked to the user who created it; list endpoints and the admin UI **only expose the current user's URLs** unless the Admin token with `email` is used.
